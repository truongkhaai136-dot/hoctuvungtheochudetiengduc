<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Lọc Tiếng Đức (Nâng cao)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2, h3 {
            color: #444;
        }
        .controls, .practice-controls {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .practice-controls div {
            margin-bottom: 8px;
        }
        #navigation-controls {
            display: none; /* Ẩn mặc định */
            margin: 20px 0;
            text-align: center;
        }
        #navigation-controls button {
            font-size: 1.1em;
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
        }
        #pair-counter {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0 15px;
        }
        #fileInput {
            font-size: 1em;
        }
        #content-container {
            margin-top: 20px;
        }
        .dialogue-pair {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dialogue-pair.hidden {
            display: none;
        }
        .line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .line .text {
            flex-grow: 1;
            font-size: 1.1em;
            margin-right: 10px;
        }
        .play-btn, .practice-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .play-btn:hover {
            background-color: #0056b3;
        }
        .toggle-answer {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 5px;
        }
        .toggle-answer:hover {
            background-color: #218838;
        }
        .answer {
            display: none; 
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        /* Styles cho tính năng mới */
        .practice-btn.play {
            background-color: #007bff;
        }
        .practice-btn.record {
            background-color: #dc3545;
        }
        .practice-btn.recording {
            background-color: #ffc107;
            color: #333;
        }
        .user-transcription {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.95em;
        }
        .user-transcription .correct-text {
            color: #666; 
        }
        .user-transcription .user-text {
            font-style: italic;
        }
        #strictModeCheck-label {
            color: #c9302c;
            font-weight: bold;
        }
        #autoPlayCheck-label {
            color: #0056b3;
            font-weight: bold;
        }
        
        /* Style cho chấm điểm */
        .diff-correct {
            color: #28a745;
            font-weight: bold;
        }
        .diff-incorrect {
            color: #dc3545;
            text-decoration: line-through;
            font-weight: bold;
        }
        .diff-extra {
            color: #f0ad4e;
            font-style: italic;
        }

    </style>
</head>
<body>

    <h1>Công cụ Học Tiếng Đức Tương Tác (Nâng cao)</h1>

    <div class="practice-controls">
        <h3>Chế độ Luyện tập</h3>
        <div>
            <input type="radio" name="practiceMode" value="off" id="modeOff" checked>
            <label for="modeOff"><strong>Tắt (Xem tất cả)</strong> - Chế độ xem/nghe thông thường.</label>
        </div>
        <div>
            <input type="radio" name="practiceMode" value="compQ_userA" id="modeQ">
            <label for="modeQ"><strong>Luyện nói (A):</strong> Máy đọc Câu hỏi (Q), Tôi đọc Câu trả lời (A)</label>
        </div>
        <div>
            <input type="radio" name="practiceMode" value="compA_userQ" id="modeA">
            <label for="modeA"><strong>Luyện nói (Q):</strong> Máy đọc Câu trả lời (A), Tôi đọc Câu hỏi (Q)</label>
        </div>
        <hr>
        <div>
            <input type="checkbox" id="autoPlayCheck">
            <label for="autoPlayCheck" id="autoPlayCheck-label"><strong>Tự động phát:</strong> Tự động đọc phần của máy.</label>
        </div>
        <div>
            <input type="checkbox" id="strictModeCheck">
            <label for="strictModeCheck" id="strictModeCheck-label"><strong>Chế độ Nghiêm khắc:</strong> Tự động chuyển câu nếu đọc ĐÚNG 100%.</label>
        </div>
        <p style="font-size: 0.9em; color: #555;"><i>(Khi bật chế độ luyện tập, trình duyệt sẽ yêu cầu quyền sử dụng Micro của bạn.)</i></p>
    </div>
    
    <div class="controls">
        <p>Chọn các file <strong>chuong-*.html</strong> của bạn để xử lý:</p>
        <input type="file" id="fileInput" multiple accept=".html">
    </div>

    <div id="navigation-controls">
        <button id="prevBtn">&laquo; Câu trước</button>
        <span id="pair-counter">Câu 1 / 10</span>
        <button id="nextBtn">Câu tiếp theo &raquo;</button>
    </div>

    <div id="content-container">
        <p>Nội dung các file của bạn sẽ xuất hiện ở đây sau khi bạn chọn chúng.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. BIẾN TOÀN CỤC ===
            let currentPairIndex = 0;
            let dialoguePairs = [];
            let targetVoice = null;
            const GERMAN_VOICE_NAME = 'Microsoft Amala Online (Natural) - German (Germany)';
            let recognition;
            let isRecording = false;
            let audioCtx = null; 

            const fileInput = document.getElementById('fileInput');
            const contentContainer = document.getElementById('content-container');
            const navControls = document.getElementById('navigation-controls');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pairCounter = document.getElementById('pair-counter');
            const modeRadios = document.querySelectorAll('input[name="practiceMode"]');
            const strictModeCheck = document.getElementById('strictModeCheck');
            const autoPlayCheck = document.getElementById('autoPlayCheck');

            // === 2. HÀM KHỞI TẠO ===

            function loadVoices() {
                function findAndSetVoice() {
                    const voices = speechSynthesis.getVoices();
                    targetVoice = voices.find(v => v.name === GERMAN_VOICE_NAME && v.lang === 'de-DE');
                    
                    if (targetVoice) {
                        console.log(`Đã tìm thấy và chọn giọng: ${targetVoice.name}`);
                    } else {
                        console.warn(`Không tìm thấy giọng "${GERMAN_VOICE_NAME}". Sẽ sử dụng giọng 'de-DE' mặc định của trình duyệt.`);
                    }
                }
                findAndSetVoice();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = findAndSetVoice;
                }
            }

            function setupRecognition() {
                window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!window.SpeechRecognition) {
                    console.error("Trình duyệt của bạn không hỗ trợ Web Speech API (SpeechRecognition).");
                    modeRadios.forEach(radio => {
                        if (radio.value !== 'off') radio.disabled = true;
                    });
                    strictModeCheck.disabled = true;
                    autoPlayCheck.disabled = true;
                    document.querySelector('label[for="modeQ"]').innerHTML += " (Trình duyệt không hỗ trợ)";
                    document.querySelector('label[for="modeA"]').innerHTML += " (Trình duyệt không hỗ trợ)";
                    return;
                }
                
                recognition = new SpeechRecognition();
                recognition.lang = 'de-DE';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onerror = (event) => {
                    console.error('Lỗi nhận dạng giọng nói:', event.error);
                    if(event.error === 'not-allowed') {
                        alert('Bạn đã chặn quyền truy cập micro. Vui lòng cho phép để sử dụng tính năng luyện nói.');
                    }
                    isRecording = false;
                    resetPracticeButton();
                };

                recognition.onend = () => {
                    isRecording = false;
                    resetPracticeButton();
                };
            }

            // === 3. HÀM ÂM THANH & SO SÁNH (ĐÃ NÂNG CẤP) ===

            function initAudio() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }

            function playSound(type) {
                if (!audioCtx) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                if (type === 'correct') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime); 
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); 
                } else { 
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime); 
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); 
                }
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.15); 
            }

            // Chuẩn hóa văn bản
            function normalizeText(text) {
                if (!text) return '';
                return text.toLowerCase()
                           .replace(/[.,!?;:\[\]'’]/g, '') // Bỏ hết dấu câu, dấu nháy đơn ' và nháy cong ’
                           .replace(/\s+/g, ' ') 
                           .trim();
            }

            // Hàm tính điểm và so sánh chi tiết
            function calculateDiff(userText, correctText) {
                const normCorrect = normalizeText(correctText);
                const normUser = normalizeText(userText);
                
                const correctWords = normCorrect.split(' ');
                const userWords = normUser.split(' ');
                
                let diffHTML = '<strong>So sánh chi tiết: </strong>';
                let score = 0;
                let totalWords = correctWords.length;

                correctWords.forEach((correctWord, index) => {
                    const userWord = userWords[index];
                    
                    if (userWord === correctWord) {
                        diffHTML += `<span class="diff-correct">${correctWord}</span> `;
                        score++;
                    } else {
                        diffHTML += `<span class="diff-incorrect">${correctWord}</span> `;
                    }
                });
                
                if (userWords.length > correctWords.length) {
                    const extraWords = userWords.slice(correctWords.length).join(' ');
                    diffHTML += `<span class="diff-extra">(Bạn đọc thừa: ${extraWords})</span>`;
                }
                
                const percentage = totalWords > 0 ? (score / totalWords) * 100 : 0;
                
                return {
                    originalCorrect: correctText,
                    originalUser: userText,
                    diffHTML: diffHTML,
                    percentage: Math.round(percentage),
                    score: score,
                    totalWords: totalWords,
                    isPerfectMatch: (normUser === normCorrect) 
                };
            }


            // === 4. HÀM XỬ LÝ CHÍNH (ĐÃ SỬA) ===

            function playSpeech(text, lang = 'de-DE') {
                if (!text) {
                    console.error('Không có văn bản để phát.');
                    return;
                }
                initAudio(); 
                speechSynthesis.cancel();
                if (isRecording && recognition) {
                    recognition.stop();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.9;
                
                if (targetVoice) {
                    utterance.voice = targetVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
            
            // *** HÀM DỌN DẸP MỚI (ĐÃ SỬA LỖI) ***
            function getCleanText(htmlString) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                let textContent = tempDiv.innerText || tempDiv.textContent || '';
                
                // 1. Xóa phiên âm trước
                textContent = textContent.replace(/\[.*?\]/g, '').trim();
                
                // 2. Tìm "Q:", "A:", "B:" và lấy phần sau nó
                // Dùng regex `(Q|A|B)\s*:` để xử lý cả "A:" và "A :".
                const qaIndex = textContent.search(/(Q|A|B)\s*:/i);
                if (qaIndex !== -1) {
                    // Tìm vị trí của dấu :
                    const colonIndex = textContent.indexOf(':', qaIndex);
                    // Lấy tất cả mọi thứ sau dấu :
                    textContent = textContent.substring(colonIndex + 1);
                }
                
                // 3. Trim lại lần cuối
                return textContent.trim();
            }

            function processAndCreateElement(container, qHTML, aHTML) {
                const qTextForSpeech = getCleanText(qHTML);
                const aTextForSpeech = getCleanText(aHTML);

                if (!qTextForSpeech || !aTextForSpeech) {
                    return;
                }

                const pair = document.createElement('div');
                pair.className = 'dialogue-pair hidden';

                // Câu hỏi (Q)
                const qLine = document.createElement('div');
                qLine.className = 'line q-line';
                qLine.innerHTML = `<span class="text" style="display: none;">${qHTML}</span>`; 
                const qPlayBtn = document.createElement('button');
                qPlayBtn.className = 'play-btn';
                qPlayBtn.textContent = 'Phát';
                qPlayBtn.dataset.text = qTextForSpeech;
                qLine.appendChild(qPlayBtn);
                qLine.appendChild(createPracticeButton('Q', qTextForSpeech));
                
                // Nút Ẩn/Hiện
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-answer';
                toggleBtn.textContent = 'Hiện Đáp án'; 

                // Câu trả lời (A)
                const aLine = document.createElement('div');
                aLine.className = 'line answer a-line';
                aLine.innerHTML = `<span class="text" style="display: none;">${aHTML}</span>`;
                const aPlayBtn = document.createElement('button');
                aPlayBtn.className = 'play-btn';
                aPlayBtn.textContent = 'Phát';
                aPlayBtn.dataset.text = aTextForSpeech;
                aLine.appendChild(aPlayBtn);
                aLine.appendChild(createPracticeButton('A', aTextForSpeech));

                pair.appendChild(qLine);
                pair.appendChild(toggleBtn);
                pair.appendChild(aLine);
                container.appendChild(pair);
            }
            
            function createPracticeButton(type, text) {
                const btn = document.createElement('button');
                btn.className = 'practice-btn';
                btn.dataset.type = type;
                btn.dataset.text = text;
                btn.style.display = 'none';
                return btn;
            }

            function parseHTMLFile(htmlContent, fileName, container) {
                const fileTitle = document.createElement('h2');
                fileTitle.textContent = fileName;
                container.appendChild(fileTitle);

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const potentialElements = doc.querySelectorAll('p, td');

                potentialElements.forEach(el => {
                    const isGermanElement = el.querySelector('span[lang="DE"]');
                    if (!isGermanElement) return; 

                    const html = el.innerHTML;
                    const lines = html.split(/<br\s*\/?>/i);
                    
                    if (lines.length >= 2) {
                        const qLineHTML = lines[0];
                        const aLineHTML = lines.slice(1).join('<br>'); 

                        const isQA_Pair = (qLineHTML.includes('Q:') || qLineHTML.includes('A:')) &&
                                          (aLineHTML.includes('A:') || aLineHTML.includes('B:'));
                        
                        if (isQA_Pair) {
                            processAndCreateElement(container, qLineHTML, aLineHTML);
                        }
                    }
                });
            }

            // === 5. HÀM CẬP NHẬT GIAO DIỆN (ĐÃ SỬA) ===

            function updateDisplayMode() {
                const mode = document.querySelector('input[name="practiceMode"]:checked').value;
                
                speechSynthesis.cancel();
                if (isRecording && recognition) recognition.stop();

                if (mode === 'off') {
                    navControls.style.display = 'none';
                    dialoguePairs.forEach(pair => {
                        pair.classList.remove('hidden');
                        pair.style.display = 'block';
                        
                        pair.querySelector('.q-line').style.display = 'flex';
                        pair.querySelector('.q-line .text').style.display = 'flex';
                        pair.querySelector('.q-line .play-btn').style.display = 'inline-block';
                        
                        const aLine = pair.querySelector('.a-line.answer');
                        aLine.style.display = 'none'; 
                        aLine.querySelector('.text').style.display = 'flex'; 
                        aLine.querySelector('.play-btn').style.display = 'inline-block';

                        const toggleBtn = pair.querySelector('.toggle-answer');
                        toggleBtn.style.display = 'block';
                        toggleBtn.textContent = 'Hiện Đáp án';
                        toggleBtn.dataset.target = '.a-line.answer';
                        
                        pair.querySelectorAll('.practice-btn').forEach(btn => btn.style.display = 'none');
                    });
                } else {
                    navControls.style.display = 'block';
                    showPair(currentPairIndex);
                    triggerAutoPlay();
                }
            }

            function showPair(index) {
                const mode = document.querySelector('input[name="practiceMode"]:checked').value;
                if (mode === 'off') return;

                dialoguePairs.forEach((pair, i) => {
                    pair.style.display = (i === index) ? 'block' : 'none';
                });
                
                pairCounter.textContent = `Câu ${index + 1} / ${dialoguePairs.length}`;
                updatePracticeState(dialoguePairs[index], mode);
            }

            function updatePracticeState(pair, mode) {
                if (!pair) return;

                pair.querySelectorAll('.user-transcription').forEach(el => el.remove());
                pair.querySelectorAll('.play-btn').forEach(btn => btn.style.display = 'none');
                
                const toggleBtn = pair.querySelector('.toggle-answer');
                toggleBtn.style.display = 'block'; 

                const qLine = pair.querySelector('.q-line');
                const aLine = pair.querySelector('.a-line.answer');
                const qPracticeBtn = qLine.querySelector('.practice-btn');
                const aPracticeBtn = aLine.querySelector('.practice-btn');
                const qText = qLine.querySelector('.text');
                const aText = aLine.querySelector('.text');

                qLine.style.display = 'flex';
                aLine.style.display = 'flex';
                aLine.style.borderTop = '1px dashed #ddd';
                aLine.style.paddingTop = '10px';
                aLine.style.marginTop = '10px';

                if (mode === 'compQ_userA') { // Người dùng đọc A
                    qText.style.display = 'flex';
                    aText.style.display = 'none';
                    
                    toggleBtn.dataset.target = '.a-line.answer .text'; 
                    toggleBtn.textContent = 'Hiện Câu trả lời (A)';
                    
                    qPracticeBtn.textContent = 'Phát Câu hỏi (Q)';
                    qPracticeBtn.dataset.action = 'play';
                    aPracticeBtn.textContent = 'Click để Đọc (A)';
                    aPracticeBtn.dataset.action = 'record';

                } else if (mode === 'compA_userQ') { // Người dùng đọc Q
                    qText.style.display = 'none';
                    aText.style.display = 'flex';

                    toggleBtn.dataset.target = '.q-line .text'; 
                    toggleBtn.textContent = 'Hiện Câu hỏi (Q)';

                    qPracticeBtn.textContent = 'Click để Đọc (Q)';
                    qPracticeBtn.dataset.action = 'record';
                    aPracticeBtn.textContent = 'Phát Câu trả lời (A)';
                    aPracticeBtn.dataset.action = 'play';
                }
                
                qPracticeBtn.style.display = 'inline-block';
                aPracticeBtn.style.display = 'inline-block';
            }

            // === 6. HÀM LUYỆN NÓI & ĐIỀU HƯỚNG (ĐÃ NÂNG CẤP) ===
            
            function triggerAutoPlay() {
                if (!autoPlayCheck.checked) return; 
                if (currentPairIndex >= dialoguePairs.length) return; 
                
                const activePair = dialoguePairs[currentPairIndex];
                if (!activePair) return;

                const mode = document.querySelector('input[name="practiceMode"]:checked').value;
                let textToPlay = null;

                if (mode === 'compQ_userA') {
                    textToPlay = activePair.querySelector('.q-line .practice-btn').dataset.text;
                } else if (mode === 'compA_userQ') {
                    textToPlay = activePair.querySelector('.a-line .practice-btn').dataset.text;
                }

                if (textToPlay) {
                    playSpeech(textToPlay);
                }
            }

            function goToNextPair() {
                if (currentPairIndex < dialoguePairs.length - 1) {
                    currentPairIndex++;
                } else {
                    alert("Hoàn thành! Bạn đã luyện tập tất cả các câu. Quay về câu đầu.");
                    currentPairIndex = 0; 
                }
                showPair(currentPairIndex); 
                triggerAutoPlay(); 
            }

            function startRecognition(button, correctText) {
                if (!recognition) {
                    alert("Tính năng nhận dạng giọng nói chưa sẵn sàng hoặc không được hỗ trợ.");
                    return;
                }
                if (isRecording) {
                    recognition.stop();
                    return;
                }

                initAudio(); 
                isRecording = true;
                speechSynthesis.cancel();
                
                const currentPair = button.closest('.dialogue-pair');
                currentPair.querySelectorAll('.user-transcription').forEach(el => el.remove());

                recognition.onstart = () => {
                    button.textContent = 'Đang nghe...';
                    button.classList.add('recording');
                };

                recognition.onresult = (event) => {
                    const userText = event.results[0][0].transcript;
                    
                    const diffData = calculateDiff(userText, correctText);
                    
                    if (strictModeCheck.checked) {
                        // **Chỉ chuyển câu nếu khớp 100% (cả điểm và isPerfectMatch)**
                        if (diffData.isPerfectMatch && diffData.percentage === 100) { 
                            playSound('correct');
                            setTimeout(goToNextPair, 400); 
                        } else {
                            playSound('incorrect');
                            displayTranscription(button.closest('.line'), diffData); 
                        }
                    } else {
                        displayTranscription(button.closest('.line'), diffData);
                    }
                };

                recognition.start();
            }

            // Hàm hiển thị chấm điểm mới
            function displayTranscription(lineEl, data) {
                const textEl = lineEl.querySelector('.text');
                if (textEl) textEl.style.display = 'flex';

                const pair = lineEl.closest('.dialogue-pair');
                const toggleBtn = pair.querySelector('.toggle-answer');
                if (toggleBtn.textContent.includes('Hiện')) {
                    toggleBtn.textContent = toggleBtn.textContent.replace('Hiện', 'Ẩn');
                }

                const div = document.createElement('div');
                div.className = 'user-transcription';
                
                const color = (data.percentage === 100 && data.isPerfectMatch) ? '#28a745' : '#dc3545';

                div.innerHTML = `
                    <div><span class="correct-text">Đáp án đúng:</span> ${data.originalCorrect}</div>
                    <div><span class="user-text">Bạn đã đọc:</span> <span style="color:${color};">${data.originalUser}</span></div>
                    <hr style="margin: 5px 0;">
                    <div>${data.diffHTML}</div>
                    <div style="margin-top: 5px;">
                        <strong>Điểm khớp từ: ${data.percentage}%</strong> 
                        (${data.score} / ${data.totalWords} từ khớp)
                    </div>
                    ${data.percentage < 100 ? `<small><i>(Máy đã gạch bỏ từ nghe KHÔNG ĐÚNG hoặc BỊ THIẾU. Đây là lỗi nhận dạng văn bản, không phải lỗi phát âm.)</i></small>` : '<small style="color: green;"><i>Tuyệt vời! Số từ đã khớp 100%.</i></small>'}
                `;
                
                lineEl.after(div);
            }
            
            function resetPracticeButton() {
                if (currentPairIndex >= dialoguePairs.length) return;
                const activePair = dialoguePairs[currentPairIndex];
                if (!activePair) return;
                
                const mode = document.querySelector('input[name="practiceMode"]:checked').value;
                if (mode === 'off') return;

                const qBtn = activePair.querySelector('.q-line .practice-btn');
                const aBtn = activePair.querySelector('.a-line .practice-btn');

                if (mode === 'compQ_userA') {
                    aBtn.textContent = 'Click để Đọc (A)';
                    aBtn.className = 'practice-btn record';
                } else if (mode === 'compA_userQ') {
                    qBtn.textContent = 'Click để Đọc (Q)';
                    qBtn.className = 'practice-btn record';
                }
            }

            // === 7. GÁN SỰ KIỆN ===

            fileInput.addEventListener('change', async (event) => {
                initAudio();
                contentContainer.innerHTML = 'Đang xử lý...';
                const files = event.target.files;
                if (!files.length) {
                    contentContainer.innerHTML = '<p>Bạn chưa chọn file nào.</p>';
                    return;
                }
                
                contentContainer.innerHTML = ''; 
                dialoguePairs = [];
                currentPairIndex = 0;

                const readPromises = Array.from(files).map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ name: file.name, content: e.target.result });
                        reader.readAsText(file);
                    });
                });

                const fileContents = await Promise.all(readPromises);

                for (const fileData of fileContents) {
                    parseHTMLFile(fileData.content, fileData.name, contentContainer);
                }
                
                dialoguePairs = Array.from(contentContainer.querySelectorAll('.dialogue-pair'));
                
                if(dialoguePairs.length === 0) {
                     contentContainer.innerHTML = '<p>Không tìm thấy cặp hội thoại (Q:/A:) nào trong các file đã chọn.</p>';
                     navControls.style.display = 'none';
                     return;
                }
                
                updateDisplayMode();
                triggerAutoPlay(); 
            });

            contentContainer.addEventListener('click', (event) => {
                initAudio();
                const target = event.target;
                const mode = document.querySelector('input[name="practiceMode"]:checked').value;

                if (target.classList.contains('toggle-answer')) {
                    let elementToToggle;
                    
                    if (mode === 'off') {
                        elementToToggle = target.nextElementSibling; 
                    } else {
                        const targetSelector = target.dataset.target;
                        elementToToggle = target.closest('.dialogue-pair').querySelector(targetSelector);
                    }

                    if (elementToToggle) {
                        if (elementToToggle.style.display === 'none' || elementToToggle.style.display === '') {
                            elementToToggle.style.display = 'flex';
                            target.textContent = target.textContent.replace('Hiện', 'Ẩn'); 
                        } else {
                            elementToToggle.style.display = 'none';
                            target.textContent = target.textContent.replace('Ẩn', 'Hiện');
                        }
                    }
                }

                else if (mode === 'off' && target.classList.contains('play-btn')) {
                    const textToPlay = target.dataset.text; 
                    playSpeech(textToPlay, 'de-DE');
                }
                
                else if (mode !== 'off' && target.classList.contains('practice-btn')) {
                    const action = target.dataset.action;
                    const text = target.dataset.text;
                    
                    if (action === 'play') {
                        playSpeech(text);
                    } else if (action === 'record') {
                        startRecognition(target, text);
                    }
                }
            });

            modeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    initAudio();
                    updateDisplayMode();
                });
            });

            nextBtn.addEventListener('click', goToNextPair);

            prevBtn.addEventListener('click', () => {
                if (currentPairIndex > 0) {
                    currentPairIndex--;
                    showPair(currentPairIndex);
                    triggerAutoPlay();
                }
            });

            // === 8. CHẠY KHỞI TẠO ===
            loadVoices();
            setupRecognition();

        }); // Kết thúc DOMContentLoaded
    </script>

</body>
</html>
